library(testthat)
library(rIACI)

test_that("download_data ????????????????????????", {
  # ??????????????????
  start_year <- 2020
  end_year <- 2020
  start_month <- 1
  end_month <- 1
  variables <- c("2m_temperature", "total_precipitation")
  dataset <- "reanalysis-era5-land"
  area <- c(44, -10, 36, 4)

  # ?????????????????????????????????????????????????????????????????????
  output_dir <- tempfile("cds_data_")
  dir.create(output_dir)

  # ????????????????????????????????????
  user_id <- Sys.getenv("ECMWF_USER_ID")
  user_key <- Sys.getenv("ECMWF_USER_KEY")

  # ???????????????????????????????????????
  if (user_id == "" || user_key == "") {
    skip("ECMWF ????????????????????????????????????????????? ECMWF_USER_ID ??? ECMWF_USER_KEY???")
  }

  # ?????? download_data ????????????
  download_data(
    start_year = start_year,
    end_year = end_year,
    start_month = start_month,
    end_month = end_month,
    variables = variables,
    dataset = dataset,
    area = area,
    output_dir = output_dir,
    user_id = user_id,
    user_key = user_key,
    max_retries = 1,      # ????????????????????? 1?????????????????????
    retry_delay = 0,      # ????????????
    timeout = 7200
  )

  # ?????????????????????????????????
  expected_file <- file.path(output_dir, "2020_01.nc")

  # ???????????????????????????
  expect_true(file.exists(expected_file))
})
